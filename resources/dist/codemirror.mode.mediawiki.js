"use strict";var t=require("ext.CodeMirror.v6.lib"),e=new WeakSet;function a(t){return{em:"mw-em",error:"mw-error",extNowiki:"mw-ext-nowiki",extPre:"mw-ext-pre",extTag:"mw-exttag",extTagAttribute:"mw-exttag-attribute",extTagBracket:"mw-exttag-bracket",extTagName:"mw-exttag-name",freeExtLink:"mw-free-extlink",freeExtLinkProtocol:"mw-free-extlink-protocol",htmlEntity:"mw-html-entity",link:"mw-link",linkPageName:"mw-link-pagename",nowiki:"mw-tag-nowiki",pageName:"mw-pagename",pre:"mw-tag-pre",section:"mw-section",skipFormatting:"mw-skipformatting",strong:"mw-strong",tableCaption:"mw-table-caption",templateVariableDelimiter:"mw-templatevariable-delimiter"}}const i=new class{constructor(){t._classPrivateMethodInitSpec(this,e),this.extHighlightStyles=[],this.tokenTable=this.defaultTokenTable}addTag(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.tokenTable[`mw-tag-${t}`]||(this.addToken(`mw-tag-${t}`,e),this.addToken(`mw-ext-${t}`,e))}addToken(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.tokenTable[e]||(this.tokenTable[e]=t.Tag.define(a),this.extHighlightStyles.push({tag:this.tokenTable[e],class:`cm-${e}`}))}get permittedHtmlTags(){return{b:!0,bdi:!0,del:!0,i:!0,ins:!0,u:!0,font:!0,big:!0,small:!0,sub:!0,sup:!0,h1:!0,h2:!0,h3:!0,h4:!0,h5:!0,h6:!0,cite:!0,code:!0,em:!0,s:!0,strike:!0,strong:!0,tt:!0,var:!0,div:!0,center:!0,blockquote:!0,q:!0,ol:!0,ul:!0,dl:!0,table:!0,caption:!0,pre:!0,ruby:!0,rb:!0,rp:!0,rt:!0,rtc:!0,p:!0,span:!0,abbr:!0,dfn:!0,kbd:!0,samp:!0,data:!0,time:!0,mark:!0,br:!0,wbr:!0,hr:!0,li:!0,dt:!0,dd:!0,td:!0,th:!0,tr:!0,noinclude:!0,includeonly:!0,onlyinclude:!0}}get implicitlyClosedHtmlTags(){return{br:!0,hr:!0,wbr:!0}}get tags(){return{apostrophes:"character",apostrophesBold:"strong",apostrophesItalic:"emphasis",comment:"comment",doubleUnderscore:"controlKeyword",extLink:"url",extLinkBracket:"modifier",extLinkProtocol:"namespace",extLinkText:"labelName",hr:"contentSeparator",htmlTagAttribute:"attributeName",htmlTagBracket:"angleBracket",htmlTagName:"tagName",indenting:"operatorKeyword",linkBracket:"squareBracket",linkDelimiter:"operator",linkText:"string",linkToSection:"className",list:"list",parserFunction:"unit",parserFunctionBracket:"paren",parserFunctionDelimiter:"punctuation",parserFunctionName:"keyword",sectionHeader:"heading",sectionHeader1:"heading1",sectionHeader2:"heading2",sectionHeader3:"heading3",sectionHeader4:"heading4",sectionHeader5:"heading5",sectionHeader6:"heading6",signature:"quote",tableBracket:"null",tableDefinition:"definitionOperator",tableDelimiter:"typeOperator",template:"attributeValue",templateArgumentName:"definitionKeyword",templateBracket:"bracket",templateDelimiter:"separator",templateName:"moduleKeyword",templateVariable:"atom",templateVariableBracket:"brace",templateVariableName:"variableName",...t._classPrivateGetter(e,this,a)}}get defaultTokenTable(){return{[this.tags.em]:t.Tag.define(),[this.tags.error]:t.Tag.define(),[this.tags.extNowiki]:t.Tag.define(),[this.tags.extPre]:t.Tag.define(),[this.tags.extTag]:t.Tag.define(),[this.tags.extTagAttribute]:t.Tag.define(),[this.tags.extTagBracket]:t.Tag.define(),[this.tags.extTagName]:t.Tag.define(),[this.tags.freeExtLink]:t.Tag.define(),[this.tags.freeExtLinkProtocol]:t.Tag.define(),[this.tags.htmlEntity]:t.Tag.define(),[this.tags.link]:t.Tag.define(),[this.tags.linkPageName]:t.Tag.define(),[this.tags.nowiki]:t.Tag.define(),[this.tags.pageName]:t.Tag.define(),[this.tags.pre]:t.Tag.define(),[this.tags.section]:t.Tag.define(),[this.tags.skipFormatting]:t.Tag.define(),[this.tags.strong]:t.Tag.define(),[this.tags.tableCaption]:t.Tag.define(),[this.tags.templateVariableDelimiter]:t.Tag.define()}}getTagStyles(e){return[{tag:t.tags[this.tags.apostrophes],class:"cm-mw-apostrophes"},{tag:t.tags[this.tags.apostrophesBold],class:"cm-mw-apostrophes-bold"},{tag:t.tags[this.tags.apostrophesItalic],class:"cm-mw-apostrophes-italic"},{tag:t.tags[this.tags.comment],class:"cm-mw-comment"},{tag:t.tags[this.tags.doubleUnderscore],class:"cm-mw-double-underscore"},{tag:t.tags[this.tags.extLink],class:"cm-mw-extlink"},{tag:t.tags[this.tags.extLinkBracket],class:"cm-mw-extlink-bracket"},{tag:t.tags[this.tags.extLinkProtocol],class:"cm-mw-extlink-protocol"},{tag:t.tags[this.tags.extLinkText],class:"cm-mw-extlink-text"},{tag:t.tags[this.tags.hr],class:"cm-mw-hr"},{tag:t.tags[this.tags.htmlTagAttribute],class:"cm-mw-htmltag-attribute"},{tag:t.tags[this.tags.htmlTagBracket],class:"cm-mw-htmltag-bracket"},{tag:t.tags[this.tags.htmlTagName],class:"cm-mw-htmltag-name"},{tag:t.tags[this.tags.indenting],class:"cm-mw-indenting"},{tag:t.tags[this.tags.linkBracket],class:"cm-mw-link-bracket"},{tag:t.tags[this.tags.linkDelimiter],class:"cm-mw-link-delimiter"},{tag:t.tags[this.tags.linkText],class:"cm-mw-link-text"},{tag:t.tags[this.tags.linkToSection],class:"cm-mw-link-tosection"},{tag:t.tags[this.tags.list],class:"cm-mw-list"},{tag:t.tags[this.tags.parserFunction],class:"cm-mw-parserfunction"},{tag:t.tags[this.tags.parserFunctionBracket],class:"cm-mw-parserfunction-bracket"},{tag:t.tags[this.tags.parserFunctionDelimiter],class:"cm-mw-parserfunction-delimiter"},{tag:t.tags[this.tags.parserFunctionName],class:"cm-mw-parserfunction-name"},{tag:t.tags[this.tags.sectionHeader],class:"cm-mw-section-header"},{tag:t.tags[this.tags.sectionHeader1],class:"cm-mw-section-1"},{tag:t.tags[this.tags.sectionHeader2],class:"cm-mw-section-2"},{tag:t.tags[this.tags.sectionHeader3],class:"cm-mw-section-3"},{tag:t.tags[this.tags.sectionHeader4],class:"cm-mw-section-4"},{tag:t.tags[this.tags.sectionHeader5],class:"cm-mw-section-5"},{tag:t.tags[this.tags.sectionHeader6],class:"cm-mw-section-6"},{tag:t.tags[this.tags.signature],class:"cm-mw-signature"},{tag:t.tags[this.tags.tableBracket],class:"cm-mw-table-bracket"},{tag:t.tags[this.tags.tableDefinition],class:"cm-mw-table-definition"},{tag:t.tags[this.tags.tableDelimiter],class:"cm-mw-table-delimiter"},{tag:t.tags[this.tags.template],class:"cm-mw-template"},{tag:t.tags[this.tags.templateArgumentName],class:"cm-mw-template-argument-name"},{tag:t.tags[this.tags.templateBracket],class:"cm-mw-template-bracket"},{tag:t.tags[this.tags.templateDelimiter],class:"cm-mw-template-delimiter"},{tag:t.tags[this.tags.templateName],class:"cm-mw-pagename cm-mw-template-name"},{tag:t.tags[this.tags.templateVariable],class:"cm-mw-templatevariable"},{tag:t.tags[this.tags.templateVariableBracket],class:"cm-mw-templatevariable-bracket"},{tag:t.tags[this.tags.templateVariableName],class:"cm-mw-templatevariable-name"},{tag:e.tokenTable[this.tags.em],class:"cm-mw-em"},{tag:e.tokenTable[this.tags.error],class:"cm-mw-error"},{tag:e.tokenTable[this.tags.extNowiki],class:"cm-mw-ext-nowiki"},{tag:e.tokenTable[this.tags.extPre],class:"cm-mw-ext-pre"},{tag:e.tokenTable[this.tags.extTagBracket],class:"cm-mw-exttag-bracket"},{tag:e.tokenTable[this.tags.extTag],class:"cm-mw-exttag"},{tag:e.tokenTable[this.tags.extTagAttribute],class:"cm-mw-exttag-attribute"},{tag:e.tokenTable[this.tags.extTagName],class:"cm-mw-exttag-name"},{tag:e.tokenTable[this.tags.freeExtLink],class:"cm-mw-free-extlink"},{tag:e.tokenTable[this.tags.freeExtLinkProtocol],class:"cm-mw-free-extlink-protocol"},{tag:e.tokenTable[this.tags.htmlEntity],class:"cm-mw-html-entity"},{tag:e.tokenTable[this.tags.linkPageName],class:"cm-mw-link-pagename"},{tag:e.tokenTable[this.tags.nowiki],class:"cm-mw-tag-nowiki"},{tag:e.tokenTable[this.tags.pageName],class:"cm-mw-pagename"},{tag:e.tokenTable[this.tags.pre],class:"cm-mw-tag-pre"},{tag:e.tokenTable[this.tags.section],class:"cm-mw-section"},{tag:e.tokenTable[this.tags.skipFormatting],class:"cm-mw-skipformatting"},{tag:e.tokenTable[this.tags.strong],class:"cm-mw-strong"},{tag:e.tokenTable[this.tags.tableCaption],class:"cm-mw-table-caption"},{tag:e.tokenTable[this.tags.templateVariableDelimiter],class:"cm-mw-templatevariable-delimiter"},...this.extHighlightStyles]}},s=t=>t.name.split("_").includes(i.tags.templateBracket),n=t=>t.name.split("_").includes(i.tags.templateDelimiter),l=t=>/-template[a-z\d-]+ground/u.test(t.name)&&!s(t),o=(t,e)=>"{"===t.sliceDoc(e.from,e.from+1)?1:-1,r=(e,a,i)=>{if("number"==typeof a&&(i=t.ensureSyntaxTree(e,a)),!i)return null;let r;if("number"==typeof a?(r=i.resolve(a,-1),l(r)||(r=i.resolve(a,1))):r=a,!l(r))return null;let{prevSibling:c,nextSibling:m}=r,g=1,h=n(r)?r:null;for(;m;){if(s(m)){if(g+=o(e,m),0===g)break}else!h&&1===g&&n(m)&&(h=m);({nextSibling:m}=m)}if(!m)return null;for(g=-1;c;){if(s(c)){if(g+=o(e,c),0===g)break}else-1===g&&n(c)&&(h=c);({prevSibling:c}=c)}const k=h&&h.to,p=m.from;return k&&k<p?{from:k,to:p}:null},c=e=>{const{selection:{main:{head:a}}}=e,i=r(e,a);if(i){const{from:s,to:n}=i;let l=!1;return t.foldedRanges(e).between(s,n,((t,e)=>{t===s&&e===n&&(l=!0)})),l?null:{pos:a,above:!0,create(e){const a=document.createElement("div");return a.className="cm-tooltip-fold",a.textContent="－",a.title=mw.msg("codemirror-fold-template"),a.onclick=()=>{e.dispatch({effects:t.foldEffect.of({from:s,to:n}),selection:{anchor:n}}),a.remove()},{dom:a}}}}return null},m=[{key:"Ctrl-Shift-[",mac:"Cmd-Alt-[",run(e){const{state:a}=e,i=t.ensureSyntaxTree(a,e.viewport.to);if(!i)return!1;const s=[],{selection:{ranges:n}}=a;let o=Math.max(...n.map((t=>{let{to:e}=t;return e})));for(const{from:e,to:c}of n){let n;for(e===c&&(n=i.resolve(e,-1)),n&&l(n)||(n=i.resolve(e,1));n&&n.from<=c;){const e=r(a,n,i);e?(s.push(t.foldEffect.of(e)),n=i.resolve(e.to,1),o=Math.max(o,e.to)):n=n.nextSibling}}if(s.length>0){const t=e.dom.querySelector(".cm-tooltip-fold");return t&&t.remove(),e.dispatch({effects:s,selection:{anchor:o}}),!0}return!1}},{key:"Ctrl-Shift-]",mac:"Cmd-Alt-]",run(e){const{state:a}=e,{selection:i}=a,s=[],n=t.foldedRanges(a);for(const{from:e,to:a}of i.ranges)n.between(e,a,((e,a)=>{s.push(t.unfoldEffect.of({from:e,to:a}))}));return s.length>0&&(e.dispatch({effects:s,selection:i}),!0)}},{key:"Ctrl-Alt-]",run:t.unfoldAll}];var g=[t.codeFolding({placeholderDOM(e){const a=document.createElement("span");return a.textContent="…",a.setAttribute("aria-label",mw.msg("codemirror-folded-code")),a.title=mw.msg("codemirror-unfold"),a.className="cm-foldPlaceholder",a.onclick=a=>{let{target:i}=a;const s=e.posAtDOM(i),{state:n}=e,{selection:l}=n;t.foldedRanges(n).between(s,s,((a,i)=>{a===s&&e.dispatch({effects:t.unfoldEffect.of({from:a,to:i}),selection:l})}))},a}}),t.StateField.define({create:c,update(t,e){let{state:a,docChanged:i,selection:s}=e;return i||s?c(a):t},provide:e=>t.showTooltip.from(e)}),t.keymap.of(m)];const h=t.Decoration.mark({class:"cm-bidi-isolate",bidiIsolate:t.Direction.LTR});function k(e){const a=new t.RangeSetBuilder;for(const{from:s,to:n}of e.visibleRanges){let l;t.syntaxTree(e.state).iterate({from:s,to:n,enter(t){const e=t.name.split("_").some((t=>[i.tags.htmlTagBracket,i.tags.extTagBracket].includes(t)));!l&&e?l=t.from:e&&(a.add(l,t.to,h),l=null)}})}return a.finish()}const p={provide:e=>{const a=a=>a.plugin(e)&&a.plugin(e).isolates||t.Decoration.none;return t.Prec.lowest([t.EditorView.decorations.of(a),t.EditorView.bidiIsolatedRanges.of(a)])}};var u=t.ViewPlugin.fromClass(class{constructor(e){this.isolates=k(e),this.tree=t.syntaxTree(e.state)}update(e){(e.docChanged||e.viewportChanged||t.syntaxTree(e.state)!==this.tree)&&(this.isolates=k(e.view),this.tree=t.syntaxTree(e.state))}},p);class d{constructor(t){this.config=t,this.urlProtocols=new RegExp(`^(?:${this.config.urlProtocols})(?=[^\\s {[\\]<>~).,'])`,"i"),this.isBold=!1,this.wasBold=!1,this.isItalic=!1,this.wasItalic=!1,this.firstSingleLetterWord=null,this.firstMultiLetterWord=null,this.firstSpace=null,this.oldStyle=null,this.tokens=[],this.oldTokens=[],this.tokenTable=i.tokenTable,this.registerGroundTokens(),Object.keys(this.config.tags).forEach((t=>i.addTag(t)))}registerGroundTokens(){["mw-ext-ground","mw-ext-link-ground","mw-ext2-ground","mw-ext2-link-ground","mw-ext3-ground","mw-ext3-link-ground","mw-link-ground","mw-template-ext-ground","mw-template-ext-link-ground","mw-template-ext2-ground","mw-template-ext2-link-ground","mw-template-ext3-ground","mw-template-ext3-link-ground","mw-template-ground","mw-template-link-ground","mw-template2-ext-ground","mw-template2-ext-link-ground","mw-template2-ext2-ground","mw-template2-ext2-link-ground","mw-template2-ext3-ground","mw-template2-ext3-link-ground","mw-template2-ground","mw-template2-link-ground","mw-template3-ext-ground","mw-template3-ext-link-ground","mw-template3-ext2-ground","mw-template3-ext2-link-ground","mw-template3-ext3-ground","mw-template3-ext3-link-ground","mw-template3-ground","mw-template3-link-ground"].forEach((t=>i.addToken(t)))}eatHtmlEntity(t,e){let a;return a=t.eat("#")?t.eat("x")?t.eatWhile(/[a-fA-F\d]/)&&t.eat(";"):t.eatWhile(/[\d]/)&&t.eat(";"):t.eatWhile(/[\w.\-:]/)&&t.eat(";"),a?i.tags.htmlEntity:e}makeStyle(t,e,a){return this.isBold&&(t+=" "+i.tags.strong),this.isItalic&&(t+=" "+i.tags.em),this.makeLocalStyle(t,e,a)}makeLocalStyle(t,e,a){let i="";switch(e.nTemplate){case 0:break;case 1:i+="-template";break;case 2:i+="-template2";break;default:i+="-template3"}switch(e.nExt){case 0:break;case 1:i+="-ext";break;case 2:i+="-ext2";break;default:i+="-ext3"}return e.nLink>0&&(i+="-link"),""!==i&&(t=`mw${i}-ground ${t}`),a&&e[a]--,t.trim()}eatBlock(t,e,a){return(i,s)=>(i.skipTo(e)?(!1!==a&&i.match(e),s.tokenize=s.stack.pop()):i.skipToEnd(),this.makeLocalStyle(t,s))}eatEnd(t){return(e,a)=>(e.skipToEnd(),a.tokenize=a.stack.pop(),this.makeLocalStyle(t,a))}eatChar(t,e){return(a,s)=>(s.tokenize=s.stack.pop(),a.eat(t)?this.makeLocalStyle(e,s):this.makeLocalStyle(i.tags.error,s))}eatSectionHeader(t){return(e,a)=>e.match(/^[^&<[{~]+/)?(e.eol()?(e.backUp(t),a.tokenize=this.eatEnd(i.tags.sectionHeader)):e.match(/^<!--(?!.*?-->.*?=)/,!1)&&(e.backUp(t),a.tokenize=this.eatBlock(i.tags.sectionHeader,"\x3c!--",!1)),i.tags.section):this.eatWikiText(i.tags.section)(e,a)}inVariable(t,e){return t.match(/^[^{}|]+/)?this.makeLocalStyle(i.tags.templateVariableName,e):t.eat("|")?(e.tokenize=this.inVariableDefault.bind(this),this.makeLocalStyle(i.tags.templateVariableDelimiter,e)):t.match("}}}")?(e.tokenize=e.stack.pop(),this.makeLocalStyle(i.tags.templateVariableBracket,e)):t.match("{{{")?(e.stack.push(e.tokenize),this.makeLocalStyle(i.tags.templateVariableBracket,e)):(t.next(),this.makeLocalStyle(i.tags.templateVariableName,e))}inVariableDefault(t,e){return t.match(/^[^{}[<&~]+/)?this.makeLocalStyle(i.tags.templateVariable,e):t.match("}}}")?(e.tokenize=e.stack.pop(),this.makeLocalStyle(i.tags.templateVariableBracket,e)):this.eatWikiText(i.tags.templateVariable)(t,e)}inParserFunctionName(t,e){return t.match(/^#?[^:}{~]+/)?this.makeLocalStyle(i.tags.parserFunctionName,e):t.eat(":")?(e.tokenize=this.inParserFunctionArguments.bind(this),this.makeLocalStyle(i.tags.parserFunctionDelimiter,e)):t.match("}}")?(e.tokenize=e.stack.pop(),this.makeLocalStyle(i.tags.parserFunctionBracket,e,"nExt")):this.eatWikiText(i.tags.parserFunction)(t,e)}inParserFunctionArguments(t,e){return t.match(/^[^|}{[<&~]+/)?this.makeLocalStyle(i.tags.parserFunction,e):t.eat("|")?this.makeLocalStyle(i.tags.parserFunctionDelimiter,e):t.match("}}")?(e.tokenize=e.stack.pop(),this.makeLocalStyle(i.tags.parserFunctionBracket,e,"nExt")):this.eatWikiText(i.tags.parserFunction)(t,e)}eatTemplatePageName(t){return(e,a)=>e.match(/^[\s\u00a0]*\|[\s\u00a0]*/)?(a.tokenize=this.eatTemplateArgument(!0),this.makeLocalStyle(i.tags.templateDelimiter,a)):e.match(/^[\s\u00a0]*\}\}/)?(a.tokenize=a.stack.pop(),this.makeLocalStyle(i.tags.templateBracket,a,"nTemplate")):e.match(/^[\s\u00a0]*<!--.*?-->/)?this.makeLocalStyle(i.tags.comment,a):t&&e.sol()?(a.nTemplate--,void(a.tokenize=a.stack.pop())):e.match(/^[\s\u00a0]*[^\s\u00a0|}<{&~]+/)?(a.tokenize=this.eatTemplatePageName(!0),this.makeLocalStyle(i.tags.templateName,a)):e.eatSpace()?(e.eol(),this.makeLocalStyle(i.tags.templateName,a)):this.eatWikiText(i.tags.templateName)(e,a)}eatTemplateArgument(t){return(e,a)=>t&&e.eatWhile(/[^=|}{[<&~]/)?e.eat("=")?(a.tokenize=this.eatTemplateArgument(!1),this.makeLocalStyle(i.tags.templateArgumentName,a)):this.makeLocalStyle(i.tags.template,a):e.eatWhile(/[^|}{[<&~]/)?this.makeLocalStyle(i.tags.template,a):e.eat("|")?(a.tokenize=this.eatTemplateArgument(!0),this.makeLocalStyle(i.tags.templateDelimiter,a)):e.match("}}")?(a.tokenize=a.stack.pop(),this.makeLocalStyle(i.tags.templateBracket,a,"nTemplate")):this.eatWikiText(i.tags.template)(e,a)}eatExternalLinkProtocol(t){return(e,a)=>{for(;t>0;)t--,e.next();return e.eol()?(a.nLink--,a.tokenize=a.stack.pop()):a.tokenize=this.inExternalLink.bind(this),this.makeLocalStyle(i.tags.extLinkProtocol,a)}}inExternalLink(t,e){return t.sol()?(e.nLink--,void(e.tokenize=e.stack.pop())):t.match(/^[\s\u00a0]*\]/)?(e.tokenize=e.stack.pop(),this.makeLocalStyle(i.tags.extLinkBracket,e,"nLink")):t.eatSpace()?(e.tokenize=this.inExternalLinkText.bind(this),this.makeStyle("",e)):t.match(/^[^\s\u00a0\]{&~']+/)||t.eatSpace()?("'"===t.peek()&&(t.match("''",!1)?e.tokenize=this.inExternalLinkText.bind(this):t.next()),this.makeStyle(i.tags.extLink,e)):this.eatWikiText(i.tags.extLink)(t,e)}inExternalLinkText(t,e){return t.sol()?(e.nLink--,void(e.tokenize=e.stack.pop())):t.eat("]")?(e.tokenize=e.stack.pop(),this.makeLocalStyle(i.tags.extLinkBracket,e,"nLink")):t.match(/^[^'\]{&~<]+/)?this.makeStyle(i.tags.extLinkText,e):this.eatWikiText(i.tags.extLinkText)(t,e)}inLink(t,e){return t.sol()?(e.nLink--,void(e.tokenize=e.stack.pop())):t.match(/^[\s\u00a0]*#[\s\u00a0]*/)?(e.tokenize=this.inLinkToSection.bind(this),this.makeLocalStyle(i.tags.link,e)):t.match(/^[\s\u00a0]*\|[\s\u00a0]*/)?(e.tokenize=this.eatLinkText(),this.makeLocalStyle(i.tags.linkDelimiter,e)):t.match(/^[\s\u00a0]*\]\]/)?(e.tokenize=e.stack.pop(),this.makeLocalStyle(i.tags.linkBracket,e,"nLink")):t.match(/^[\s\u00a0]*[^\s\u00a0#|\]&~{]+/)||t.eatSpace()?this.makeStyle(`${i.tags.linkPageName} ${i.tags.pageName}`,e):this.eatWikiText(`${i.tags.linkPageName} ${i.tags.pageName}`)(t,e)}inLinkToSection(t,e){return t.sol()?(e.nLink--,void(e.tokenize=e.stack.pop())):t.match(/^[^|\]&~{}]+/)?this.makeLocalStyle(i.tags.linkToSection,e):t.eat("|")?(e.tokenize=this.eatLinkText(),this.makeLocalStyle(i.tags.linkDelimiter,e)):t.match("]]")?(e.tokenize=e.stack.pop(),this.makeLocalStyle(i.tags.linkBracket,e,"nLink")):this.eatWikiText(i.tags.linkToSection)(t,e)}eatLinkText(){let t,e;return(a,s)=>{let n;return a.match("]]")?(s.tokenize=s.stack.pop(),this.makeLocalStyle(i.tags.linkBracket,s,"nLink")):a.match("'''")?(t=!t,this.makeLocalStyle(`${i.tags.linkText} ${i.tags.apostrophes}`,s)):a.match("''")?(e=!e,this.makeLocalStyle(`${i.tags.linkText} ${i.tags.apostrophes}`,s)):(n=i.tags.linkText,t&&(n+=" "+i.tags.strong),e&&(n+=" "+i.tags.em),a.match(/^[^'\]{&~<]+/)?this.makeStyle(n,s):this.eatWikiText(n)(a,s))}}eatTagName(t,e,a){return(s,n)=>{let l="";for(;t>0;)t--,l+=s.next();return s.eatSpace(),l=l.toLowerCase(),a?(e&&!i.implicitlyClosedHtmlTags[l]?n.tokenize=this.eatChar(">",i.tags.htmlTagBracket):n.tokenize=this.eatHtmlTagAttribute(l),this.makeLocalStyle(i.tags.htmlTagName,n)):(n.tokenize=e?this.eatChar(">",`${i.tags.extTagBracket} mw-ext-${l}`):this.eatExtTagAttribute(l),this.makeLocalStyle(`${i.tags.extTagName} mw-ext-${l}`,n))}}eatHtmlTagAttribute(t){return(e,a)=>e.match(/^(?:"[^<">]*"|'[^<'>]*'|[^>/<{&~])+/)?this.makeLocalStyle(i.tags.htmlTagAttribute,a):e.eat(">")?(t in i.implicitlyClosedHtmlTags||a.inHtmlTag.push(t),a.tokenize=a.stack.pop(),this.makeLocalStyle(i.tags.htmlTagBracket,a)):e.match("/>")?(a.tokenize=a.stack.pop(),this.makeLocalStyle(i.tags.htmlTagBracket,a)):this.eatWikiText(i.tags.htmlTagAttribute)(e,a)}eatNowiki(){return t=>t.match(/^[^&]+/)?"":(t.next(),this.eatHtmlEntity(t,""))}eatExtTagAttribute(t){return(e,a)=>{if(e.match(/^(?:"[^">]*"|'[^'>]*'|[^>/<{&~])+/))return this.makeLocalStyle(`${i.tags.extTagAttribute} mw-ext-${t}`,a);if(e.eat(">")){if(a.extName=t,"nowiki"===t||"pre"===t)a.extMode={startState:()=>{},copyState:()=>{},token:this.eatNowiki()};else if(t in this.config.tagModes){const e=this.config.tagModes[t];"mediawiki"!==e&&"text/mediawiki"!==e||(a.extMode=this.mediawiki,a.extState=a.extMode.startState())}return a.tokenize=this.eatExtTagArea(t),this.makeLocalStyle(`${i.tags.extTagBracket} mw-ext-${t}`,a)}return e.match("/>")?(a.tokenize=a.stack.pop(),this.makeLocalStyle(`${i.tags.extTagBracket} mw-ext-${t}`,a)):this.eatWikiText(`${i.tags.extTagAttribute} mw-ext-${t}`)(e,a)}}eatExtTagArea(t){return(e,a)=>{const i=e.pos,s=new RegExp(`</${t}\\s*>`,"i").exec(i?e.string.slice(i):e.string);let n,l=!1;if(s){if(0===s.index)return a.tokenize=this.eatExtCloseTag(t),a.extName=!1,!1!==a.extMode&&(a.extMode=!1,a.extState=!1),a.tokenize(e,a);n=s.index+i,l=e.string,e.string=l.slice(0,n)}return a.stack.push(a.tokenize),a.tokenize=this.eatExtTokens(l),a.tokenize(e,a)}}eatExtCloseTag(t){return(e,a)=>(e.next(),e.next(),a.tokenize=this.eatTagName(t.length,!0,!1),this.makeLocalStyle(`${i.tags.extTagBracket} mw-ext-${t}`,a))}eatExtTokens(t){return(e,a)=>{let s;return!1===a.extMode?(s=i.tags.extTag,e.skipToEnd()):s=`mw-tag-${a.extName} `+a.extMode.token(e,a.extState,!1===t),e.eol()&&(!1!==t&&(e.string=t),a.tokenize=a.stack.pop()),this.makeLocalStyle(s,a)}}eatStartTable(t,e){return t.match("{|"),t.eatSpace(),e.tokenize=this.inTableDefinition.bind(this),i.tags.tableBracket}inTableDefinition(t,e){return t.sol()?(e.tokenize=this.inTable.bind(this),this.inTable(t,e)):this.eatWikiText(i.tags.tableDefinition)(t,e)}inTable(t,e){if(t.sol()){if(t.eatSpace(),t.eat("|"))return t.eat("-")?(t.eatSpace(),e.tokenize=this.inTableDefinition.bind(this),this.makeLocalStyle(i.tags.tableDelimiter,e)):t.eat("+")?(t.eatSpace(),e.tokenize=this.eatTableRow(!0,!1,!0),this.makeLocalStyle(i.tags.tableDelimiter,e)):t.eat("}")?(e.tokenize=e.stack.pop(),this.makeLocalStyle(i.tags.tableBracket,e)):(t.eatSpace(),e.tokenize=this.eatTableRow(!0,!1),this.makeLocalStyle(i.tags.tableDelimiter,e));if(t.eat("!"))return t.eatSpace(),e.tokenize=this.eatTableRow(!0,!0),this.makeLocalStyle(i.tags.tableDelimiter,e)}return this.eatWikiText("")(t,e)}eatTableRow(t,e,a){let s="";return a?s=i.tags.tableCaption:e&&(s=i.tags.strong),(n,l)=>{if(n.sol()){if(n.match(/^[\s\u00a0]*[|!]/,!1))return l.tokenize=this.inTable.bind(this),this.inTable(n,l)}else{if(n.match(/^[^'|{[<&~!]+/))return this.makeStyle(s,l);if(n.match("||")||e&&n.match("!!"))return this.isBold=!1,this.isItalic=!1,l.tokenize=this.eatTableRow(!0,e,a),this.makeLocalStyle(i.tags.tableDelimiter,l);if(t&&n.eat("|"))return l.tokenize=this.eatTableRow(!1,e,a),this.makeLocalStyle(i.tags.tableDelimiter,l)}return this.eatWikiText(s)(n,l)}}eatFreeExternalLinkProtocol(t,e){return t.match(this.urlProtocols),e.tokenize=this.eatFreeExternalLink.bind(this),this.makeLocalStyle(i.tags.freeExtLinkProtocol,e)}eatFreeExternalLink(t,e){if(t.eol());else if(t.match(/^[^\s\u00a0{[\]<>~).,']*/))if("~"===t.peek()){if(!t.match(/^~~~+/,!1))return t.match(/^~*/),this.makeLocalStyle(i.tags.freeExtLink,e)}else if("{"===t.peek()){if(!t.match("{{",!1))return t.next(),this.makeLocalStyle(i.tags.freeExtLink,e)}else if("'"===t.peek()){if(!t.match("''",!1))return t.next(),this.makeLocalStyle(i.tags.freeExtLink,e)}else if(t.match(/^[).,]+(?=[^\s\u00a0{[\]<>~).,])/))return this.makeLocalStyle(i.tags.freeExtLink,e);return e.tokenize=e.stack.pop(),this.makeLocalStyle(i.tags.freeExtLink,e)}eatWikiText(t){return(e,a)=>{let s,n,l,o,r,c;if(e.sol()){if(!e.match("//",!1)&&e.match(this.urlProtocols))return a.stack.push(a.tokenize),a.tokenize=this.eatFreeExternalLink.bind(this),this.makeLocalStyle(i.tags.freeExtLinkProtocol,a);switch(s=e.next(),s){case"-":if(e.match(/^---+/))return i.tags.hr;break;case"=":if(n=e.match(/^(={0,5})(.+?(=\1\s*)(<!--(?!.*-->.*\S).*?)?)$/),n)return e.backUp(n[2].length),a.stack.push(a.tokenize),a.tokenize=this.eatSectionHeader(n[3].length),i.tags.sectionHeader+" "+i.tags[`sectionHeader${n[1].length+1}`];break;case"*":case"#":case";":return e.match(/^[*#;:]*/),i.tags.list;case":":return e.match(/^:*{\|/,!1)&&(a.stack.push(a.tokenize),a.tokenize=this.eatStartTable.bind(this)),e.match(/^[*#;:]*/),i.tags.indenting;case" ":if(!e.match(/^[\s\u00a0]*:*{\|/,!1))return i.tags.skipFormatting;if(e.eatSpace(),e.match(/^:+/))return a.stack.push(a.tokenize),a.tokenize=this.eatStartTable.bind(this),i.tags.indenting;e.eat("{");case"{":if(e.eat("|"))return e.eatSpace(),a.stack.push(a.tokenize),a.tokenize=this.inTableDefinition.bind(this),i.tags.tableBracket}}else s=e.next();switch(s){case"&":return this.makeStyle(this.eatHtmlEntity(e,t),a);case"'":if(e.match(/^'*(?=''''')/)||e.match(/^'''(?!')/,!1))break;if(e.match("''"))return this.firstSingleLetterWord||e.match("''",!1)||this.prepareItalicForCorrection(e),this.isBold=!this.isBold,this.makeLocalStyle(i.tags.apostrophesBold,a);if(e.eat("'"))return this.isItalic=!this.isItalic,this.makeLocalStyle(i.tags.apostrophesItalic,a);break;case"[":if(e.eat("[")){if(e.eatSpace(),/[^\]|[]/.test(e.peek()))return a.nLink++,a.stack.push(a.tokenize),a.tokenize=this.inLink.bind(this),this.makeLocalStyle(i.tags.linkBracket,a)}else if(l=e.match(this.urlProtocols),l)return a.nLink++,e.backUp(l[0].length),a.stack.push(a.tokenize),a.tokenize=this.eatExternalLinkProtocol(l[0].length),this.makeLocalStyle(i.tags.extLinkBracket,a);break;case"{":if(e.match(/^{{(?!{|[^{}]*}}(?!}))/))return e.eatSpace(),a.stack.push(a.tokenize),a.tokenize=this.inVariable.bind(this),this.makeLocalStyle(i.tags.templateVariableBracket,a);if(e.match(/^{(?!{(?!{))[\s\u00a0]*/))return"#"===e.peek()?(a.nExt++,a.stack.push(a.tokenize),a.tokenize=this.inParserFunctionName.bind(this),this.makeLocalStyle(i.tags.parserFunctionBracket,a)):(o=e.match(/^([^\s\u00a0}[\]<{'|&:]+)(:|[\s\u00a0]*)(\}\}?)?(.)?/),!o||(e.backUp(o[0].length),":"!==o[2]&&void 0!==o[4]&&"}}"!==o[3]||!(o[1].toLowerCase()in this.config.functionSynonyms[0])&&!(o[1]in this.config.functionSynonyms[1]))?(a.nTemplate++,a.stack.push(a.tokenize),a.tokenize=this.eatTemplatePageName(!1),this.makeLocalStyle(i.tags.templateBracket,a)):(a.nExt++,a.stack.push(a.tokenize),a.tokenize=this.inParserFunctionName.bind(this),this.makeLocalStyle(i.tags.parserFunctionBracket,a)));break;case"<":if(r=!!e.eat("/"),c=e.match(/^[^>/\s\u00a0.*,[\]{}$^+?|/\\'`~<=!@#%&()-]+/),e.match("!--"))return m=this.eatBlock(i.tags.comment,"--\x3e"),a.stack.push(a.tokenize),a.tokenize=m,m(e,a);if(c){if(c=c[0].toLowerCase(),c in this.config.tags)return!0===r?i.tags.error:(e.backUp(c.length),a.stack.push(a.tokenize),a.tokenize=this.eatTagName(c.length,r,!1),this.makeLocalStyle(`${i.tags.extTagBracket} mw-ext-${c}`,a));if(c in i.permittedHtmlTags)return!0===r&&c!==a.inHtmlTag.pop()?(e.pos++,i.tags.error):!0===r&&c in i.implicitlyClosedHtmlTags?i.tags.error:(e.backUp(c.length),a.stack.push(a.tokenize),a.tokenize=this.eatTagName(c.length,r||c in i.implicitlyClosedHtmlTags,!0),this.makeLocalStyle(i.tags.htmlTagBracket,a));e.backUp(c.length)}break;case"~":if(e.match(/^~{2,4}/))return i.tags.signature;break;case"_":for(n=1;e.eat("_");)n++;if(n>2)return e.eol()||e.backUp(2),this.makeStyle(t,a);if(2===n&&(o=e.match(/^([^\s\u00a0>}[\]<{'|&:~]+?)__/),o&&o[0]))return"__"+o[0].toLowerCase()in this.config.doubleUnderscore[0]||"__"+o[0]in this.config.doubleUnderscore[1]?i.tags.doubleUnderscore:(e.eol()||e.backUp(2),this.makeStyle(t,a));break;default:if(/[\s\u00a0]/.test(s)&&(e.eatSpace(),e.match(this.urlProtocols,!1)&&!e.match("//")))return a.stack.push(a.tokenize),a.tokenize=this.eatFreeExternalLinkProtocol.bind(this),this.makeStyle(t,a)}var m;return e.match(/^[^\s\u00a0_>}[\]<{'|&:~=]+/),this.makeStyle(t,a)}}prepareItalicForCorrection(t){const e=t.pos,a=t.string.slice(0,e-3),i=a.slice(-1),s=a.slice(-2,-1);if(" "===i){if(this.firstMultiLetterWord||this.firstSpace)return;this.firstSpace=e}else if(" "===s)this.firstSingleLetterWord=e;else{if(this.firstMultiLetterWord)return;this.firstMultiLetterWord=e}this.wasBold=this.isBold,this.wasItalic=this.isItalic}get mediawiki(){return{name:"mediawiki",startState:()=>({tokenize:this.eatWikiText(""),stack:[],inHtmlTag:[],extName:!1,extMode:!1,extState:!1,nTemplate:0,nLink:0,nExt:0}),copyState:t=>({tokenize:t.tokenize,stack:t.stack.concat([]),inHtmlTag:t.inHtmlTag.concat([]),extName:t.extName,extMode:t.extMode,extState:!1!==t.extMode&&t.extMode.copyState(t.extState),nTemplate:t.nTemplate,nLink:t.nLink,nExt:t.nExt}),token:(t,e)=>{let a,i,s,n,l=[],o=[];if(this.oldTokens.length>0)return s=this.oldTokens.shift(),t.pos=s.pos,e=s.state,s.style;t.sol()&&(this.isBold=!1,this.isItalic=!1,this.firstSingleLetterWord=null,this.firstMultiLetterWord=null,this.firstSpace=null);do{if(a=e.tokenize(t,e),n=this.firstSingleLetterWord||this.firstMultiLetterWord||this.firstSpace,!n)return this.oldStyle=a,a;n!==i&&(i=n,o.length>0&&(l=l.concat(o),o=[])),o.push({pos:t.pos,style:a,state:(e.extMode||this.mediawiki).copyState(e)})}while(!t.eol());if(this.isBold&&this.isItalic){if(this.isItalic=this.wasItalic,this.isBold=this.wasBold,this.firstSingleLetterWord=null,this.firstMultiLetterWord=null,this.firstSpace=null,!(l.length>0))return t.pos=o[0].pos-2,this.oldStyle;l[l.length-1].pos++,this.oldTokens=l}else this.oldTokens=l.concat(o);return s=this.oldTokens.shift(),t.pos=s.pos,e=s.state,s.style},blankLine:t=>{t.extMode&&t.extMode.blankLine&&t.extMode.blankLine(t.extState)},tokenTable:this.tokenTable}}}module.exports=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{bidiIsolation:!1},a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;a=a||mw.config.get("extCodeMirrorConfig");const s=new d(a).mediawiki,n=t.StreamLanguage.define(s),l=[t.syntaxHighlighting(t.HighlightStyle.define(i.getTagStyles(s)))],o=a.templateFoldingNamespaces;return o&&!o.includes(mw.config.get("wgNamespaceNumber"))||l.push(g),e.bidiIsolation&&l.push(u),new t.LanguageSupport(n,l)};
