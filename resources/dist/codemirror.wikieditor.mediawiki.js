"use strict";var e=require("ext.CodeMirror.v6.lib"),t=require("ext.CodeMirror.v6"),i=require("ext.CodeMirror.v6.mode.mediawiki");class r extends t{constructor(e,t){super(e),this.langExtension=t,this.useCodeMirror=mw.user.options.get("usecodemirror")>0}setCodeMirrorPreference(e){this.useCodeMirror=e,super.setCodeMirrorPreference(e)}enableCodeMirror(){if(this.view)return;const t=this.$textarea.prop("selectionStart"),i=this.$textarea.prop("selectionEnd"),r=this.$textarea.scrollTop(),o=this.$textarea.is(":focus"),s=[this.defaultExtensions,this.langExtension,e.search({top:!0}),e.EditorView.domEventHandlers({blur:()=>this.$textarea.triggerHandler("blur"),focus:()=>this.$textarea.triggerHandler("focus"),keydown(e,t){if("Tab"===e.key){e.preventDefault();const t=$("#wpSummary");t.length&&t.trigger("focus")}if("Shift"===e.key){e.preventDefault();const i=t.state.selection.main.head,r=t.coordsAtPos(i),o=t.dom.getBoundingClientRect();(r.top<o.top||r.top>o.bottom)&&$(t.dom).textSelection("scrollToCaretPosition")}return!1}}),e.EditorView.lineWrapping];if(this.initialize(s),$(".group-search a").on("click",(()=>{e.openSearchPanel(this.view)})),setTimeout((()=>{this.view.scrollDOM.scrollTop=r})),this.view.scrollDOM.style.height=`${this.$textarea.height()}px`,0!==t||0!==i){const r=e.EditorSelection.range(t,i),o=e.EditorView.scrollIntoView(r);o.value.isSnapshot=!0,this.view.dispatch({selection:e.EditorSelection.create([r]),effects:o})}o&&this.view.focus(),mw.hook("ext.CodeMirror.switch").fire(!0,$(this.view.dom))}addCodeMirrorToWikiEditor(){const e=this.$textarea.data("wikiEditor-context"),t=e&&e.modules&&e.modules.toolbar;if(!t)return;this.$textarea.wikiEditor("addToToolbar",{section:"main",groups:{codemirror:{tools:{CodeMirror:{label:mw.msg("codemirror-toggle-label"),type:"toggle",oouiIcon:"highlight",action:{type:"callback",execute:()=>this.switchCodeMirror()}}}}}});t.$toolbar.find(".tool[rel=CodeMirror]").attr("id","mw-editbutton-codemirror"),this.readOnly&&this.$textarea.data("wikiEditor-context").$ui.addClass("ext-codemirror-readonly"),this.useCodeMirror&&this.enableCodeMirror(),this.updateToolbarButton(),this.logUsage({editor:"wikitext",enabled:this.useCodeMirror,toggled:!1,edit_start_ts_ms:1e3*parseInt($('input[name="wpStarttime"]').val(),10)||0})}updateToolbarButton(){const e=$("#mw-editbutton-codemirror");e.toggleClass("mw-editbutton-codemirror-active",this.useCodeMirror),e.data("setActive")&&e.data("setActive")(this.useCodeMirror)}switchCodeMirror(){if(this.view){this.setCodeMirrorPreference(!1);const e=this.view.scrollDOM.scrollTop,t=this.view.hasFocus,{from:i,to:r}=this.view.state.selection.ranges[0];$(this.view.dom).textSelection("unregister"),this.$textarea.textSelection("unregister"),this.$textarea.val(this.view.state.doc.toString()),this.view.destroy(),this.view=null,this.textSelection=null,this.$textarea.show(),t&&this.$textarea.trigger("focus"),this.$textarea.prop("selectionStart",Math.min(i,r)).prop("selectionEnd",Math.max(r,i)),this.$textarea.scrollTop(e),mw.hook("ext.CodeMirror.switch").fire(!1,this.$textarea)}else this.enableCodeMirror(),this.setCodeMirrorPreference(!0);this.updateToolbarButton(),this.logUsage({editor:"wikitext",enabled:this.useCodeMirror,toggled:!0,edit_start_ts_ms:1e3*parseInt($('input[name="wpStarttime"]').val(),10)||0})}}mw.loader.getState("ext.wikiEditor")&&mw.hook("wikiEditor.toolbarReady").add((e=>{(window.WikiEditorCodeMirror=new r(e,i({bidiIsolation:"rtl"===e.attr("dir")}))).addCodeMirrorToWikiEditor()})),window.registerCodeMirrorKeyHandler=function(t){const i=e.EditorView.domEventHandlers({keydown:(e,i)=>t(e,i)});window.WikiEditorCodeMirror.view.dispatch({effects:e.StateEffect.appendConfig.of(e.Prec.high(i))})},window.registerCodeMirrorScrollHandler=function(t){const i=e.EditorView.domEventHandlers({scroll:(e,i)=>t(e,i)});window.WikiEditorCodeMirror.view.dispatch({effects:e.StateEffect.appendConfig.of(i)})};
