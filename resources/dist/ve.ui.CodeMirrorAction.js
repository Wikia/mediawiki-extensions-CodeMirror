"use strict";var e=require("ext.CodeMirror.v6.mode.mediawiki"),t=require("ext.CodeMirror.v6.lib");class r{constructor(e,t){this.surface=e,this.langExtension=t,this.view=null,this.state=null,this.useCodeMirror=mw.user.options.get("usecodemirror")>0}get defaultExtensions(){const e=[this.contentAttributesExtension],r=mw.config.get("wgCodeMirrorLineNumberingNamespaces");return r&&!r.includes(mw.config.get("wgNamespaceNumber"))||e.push(t.lineNumbers()),e}get contentAttributesExtension(){return t.EditorView.contentAttributes.of({dir:$(this.surface.getView()[0]).attr("dir"),lang:$(this.surface.getView()[0]).attr("lang")})}initialize(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.defaultExtensions;this.state=t.EditorState.create({doc:this.surface.getDom(),extensions:e}),this.view=new t.EditorView({state:this.state,parent:this.surface.getView().$element[0]}),this.view.viewState.printing=!0,mw.hook("ext.CodeMirror.switch").fire(!0,$(this.view.dom))}logUsage(e){const t=Object.assign({session_token:mw.user.sessionId(),user_id:mw.user.getId()},e),r=mw.config.get("wgUserEditCountBucket");null!==r&&(t.user_edit_count_bucket=r),mw.track("event.CodeMirrorUsage",t)}setCodeMirrorPreference(e){mw.user.isAnon()||((new mw.Api).saveOption("usecodemirror",e?1:0),mw.user.options.set("usecodemirror",e?1:0))}enableCodeMirror(){if(this.view)return;const e=[...this.defaultExtensions,this.langExtension,t.bracketMatching(),t.history(),t.EditorView.contentAttributes.of({spellcheck:"true"}),t.EditorView.updateListener.of((e=>{e.docChanged&&"function"==typeof this.editRecoveryHandler&&this.editRecoveryHandler()})),t.EditorView.lineWrapping];mw.hook("editRecovery.loadEnd").add((e=>{this.editRecoveryHandler=e.fieldChangeHandler}));const r=$.client.profile(),o="WebkitTextFillColor"in document.body.style&&!("gecko"===r.layout&&"mac"===r.platform);this.surface.getView().$documentNode.addClass(o?"ve-ce-documentNode-codeEditor-webkit-hide":"ve-ce-documentNode-codeEditor-hide"),this.initialize(e)}}ve.ui.CodeMirrorAction=function(){ve.ui.CodeMirrorAction.super.apply(this,arguments)},OO.inheritClass(ve.ui.CodeMirrorAction,ve.ui.Action),ve.ui.CodeMirrorAction.static.name="codeMirror",ve.ui.CodeMirrorAction.static.methods=["toggle"],ve.ui.CodeMirrorAction.static.isLineNumbering=function(){if(/Android\b/.test(navigator.userAgent))return!1;const e=mw.config.get("wgCodeMirrorLineNumberingNamespaces");return!e||-1!==e.indexOf(mw.config.get("wgNamespaceNumber"))},ve.ui.CodeMirrorAction.prototype.toggle=function(t){const o=this,i=this.surface,n=i.getView(),s=i.getModel().getDocument();if(i.mirror&&i.mirror.view||!1===t)i.mirror&&!0!==t&&(s.off("precommit",i.mirror.veTransactionListener),n.$element.removeClass("mw-editfont-monospace").addClass("mw-editfont-"+mw.user.options.get("editfont")),n.$documentNode.removeClass("ve-ce-documentNode-codeEditor-webkit-hide ve-ce-documentNode-codeEditor-hide"),n.$documentNode.css("margin-left",""),i.mirror.view.destroy(),i.mirror.view=null);else{i.mirror=window.VisualEditorCodeMirror=new r(i,e()),i.mirror.enableCodeMirror();const t=parseInt(document.querySelector(".cm-gutters").offsetWidth);n.$documentNode.css("margin-left",t-5),i.mirror.veTransactionListener=o.onDocumentPrecommit.bind(o),s.on("precommit",i.mirror.veTransactionListener)}return!0},ve.ui.CodeMirrorAction.prototype.onSelect=function(e){const t=e.getCoveringRange();t&&t.isCollapsed()&&this.surface.mirror.setSelection(this.getPosFromOffset(t.from))},ve.ui.CodeMirrorAction.prototype.onLangChange=function(){const e=this.surface,t=e.getView().getDocument(),r=t.getDir(),o=t.getLang();e.mirror.setOption("direction",r),e.mirror.getWrapperElement().setAttribute("lang",o)},ve.ui.CodeMirrorAction.prototype.onDocumentPrecommit=function(e){let t=0;const r=[],o=this,i=this.surface.getModel().getDocument().getStore(),n=this.surface.mirror.view,s=document.querySelector(".ve-ce-documentNode"),c=parseInt(document.querySelector(".cm-gutters").offsetWidth);s.style.marginLeft=c-5+"px",e.operations.forEach((function(e){"retain"===e.type?t+=e.length:"replace"===e.type&&(r.push({start:"replace"===e.type?o.getPosFromOffset(t):void 0,end:e.remove.length?o.getPosFromOffset(t+e.remove.length):void 0,data:new ve.dm.ElementLinearData(i,e.insert).getSourceText()}),t+=e.remove.length)}));for(let e=r.length-1;e>=0;e--)n.dispatch({changes:{from:r[e].start,to:r[e].end,insert:r[e].data}})},ve.ui.CodeMirrorAction.prototype.getPosFromOffset=function(e){return this.surface.getModel().getSourceOffsetFromOffset(e)},ve.ui.actionFactory.register(ve.ui.CodeMirrorAction);
